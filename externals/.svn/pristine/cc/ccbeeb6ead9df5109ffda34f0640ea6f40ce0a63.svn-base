<?xml version="1.0"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant" name="axis_build">
  <import file="java_build.xml"/>
  <property name="web.base.dir" value="WebContent"/>
  <property name="web.lib.dir" value="${web.base.dir}/WEB-INF/lib"/>
  <property name="web.class.dir" value="${web.base.dir}/WEB-INF/classes"/>
	
  <property name="tomcat.url" value="http://localhost:8080/manager"/>
  <property name="tomcat.user" value="tomcat"/>
  <property name="tomcat.pass" value="123"/>
  <property name="tomcat.path" value="/${ant.project.name}"/>
  	
  <property name="warfile" value="${ant.project.name}.war" />
		
  <taskdef name="deploy" classpathref="tasks.lib.path" classname="org.apache.catalina.ant.DeployTask"/>		
	
  <target name="eclipse" description="Generate .project and .classpath files.">
    <copy tofile=".classpath" overwrite="false" failonerror="false" file="externals/eclipse/axis/classpath_template">
      <filterset>
        <filter token="PROJECT_NAME" value="${ant.project.name}"/>
      </filterset>
    </copy>
    <copy tofile=".project" overwrite="false" failonerror="false" file="externals/eclipse/axis/project_template">
      <filterset>
        <filter token="PROJECT_NAME" value="${ant.project.name}"/>
      </filterset>
    </copy>
    <copy todir=".settings" overwrite="false" failonerror="false">
      <fileset dir="externals/eclipse/axis/settings"></fileset>
    </copy>
  </target>
	
  <!--
  Axis issues:
   - When generating WebService (wsdl, wsdd etc.) Eclipse overwrites ivy libs with its own libraries.
   - Solution: Run ivy resolve after generating Web service and before running it on server for test.
   - Alternative solution: Use ant to generate web service. 
  -->
  <target name="dist" depends="compile">
  	<delete dir="${web.lib.dir}"/>
  	<copy todir="${web.lib.dir}">
  	  <fileset dir="${compile.lib.dir}">
  	  	<include name="*.jar"/>
  	  </fileset>
    </copy>
	<mkdir dir="${dist.dir}"/> 
	<war destfile="${dist.dir}/${warfile}"
			webxml="WebContent/WEB-INF/web.xml"
			update="false"
			excludes=".svn" 
			basedir="WebContent" >
	  <classes dir="${build.class.dir}" />
	  <manifest>
	    <attribute name="Implementation-Vendor" value="Skyline"/>
	    <attribute name="Implementation-Title" value="${ant.project.name}"/>
	    <attribute name="Implementation-Version" value="${project.version}"/>
		<attribute name="Pusblish-Date" value="${timestamp}"/>
	  </manifest>
	</war>
  </target>
	
  <target name="release" depends="dist" if="project.version">
  	<mkdir dir="/var/www/releases/${ant.project.name}/${ant.project.name}-${project.version}"/>
  	<copy todir="/var/www/releases/${ant.project.name}/${ant.project.name}-${project.version}">
  		<fileset dir="${dist.dir}">
  			<include name="${warfile}"/>
  		</fileset>
  	</copy>
  </target> 
	
  <target name="deploy" depends="dist">
    <deploy url="${tomcat.url}"
      username="${tomcat.user}"
      password="${tomcat.pass}"
      path="${tomcat.path}"
      update="true"
	  war="${dist.dir}/${warfile}" />
  </target>
</project>
